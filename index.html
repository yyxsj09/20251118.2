<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼éŸ³å¡«å­—éŠæˆ² (Pinyin Crossword)</title>
    <style>
        body {
            font-family: "Arial", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: #f4f6f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { color: #2c3e50; margin-bottom: 5px; }
        .sub-text { color: #7f8c8d; margin-bottom: 20px; font-size: 0.9rem;}

        .game-wrapper {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1200px;
        }

        /* ç¶²æ ¼æ¨£å¼ */
        #crossword-board {
            display: grid;
            background: #2c3e50;
            padding: 5px;
            border: 2px solid #2c3e50;
            gap: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .cell {
            width: 35px;
            height: 35px;
            background-color: #2c3e50;
            position: relative;
        }

        .cell.active {
            background-color: white;
        }

        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1.2em; /* æ‹¼éŸ³å­—æ¯å¤§å¯« */
            text-transform: uppercase;
            font-weight: bold;
            background: transparent;
            outline: none;
            padding: 0;
            color: #333;
        }
        
        .cell input:focus { background-color: #e8f6f3; }

        /* é¡Œè™Ÿ */
        .cell-number {
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 9px;
            color: #e74c3c;
            pointer-events: none;
            font-weight: bold;
            z-index: 2;
        }

        /* æç¤ºå€ */
        .clues-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .clue-section h3 {
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            color: #3498db;
            font-size: 1.1em;
        }

        ul { padding-left: 20px; margin: 0; }
        li { 
            margin-bottom: 10px; 
            color: #555; 
            line-height: 1.4; 
            font-size: 0.95em;
        }
        
        /* å¼·èª¿æ¼¢å­— */
        .hanzi-hint {
            font-weight: bold;
            color: #333;
            font-size: 1.2em;
            margin-right: 5px;
        }

        .correct { background-color: #d4efdf !important; color: #27ae60 !important; }
        .wrong { background-color: #fadbd8 !important; color: #c0392b !important; }

        .controls {
            margin-top: 25px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        
        .btn-check { background-color: #27ae60; }
        .btn-reveal { background-color: #e67e22; }
        .btn-retry { background-color: #3498db; }

        @media (max-width: 768px) {
            .cell { width: 28px; height: 28px; }
            .cell input { font-size: 0.9em; }
            .game-wrapper { flex-direction: column-reverse; align-items: center; }
            .clues-container { width: 90%; }
        }
    </style>
</head>
<body>

    <h1>æ‹¼éŸ³å¡«å­—éŠæˆ²</h1>
    <div class="sub-text">è«‹æ ¹æ“šæç¤ºè¼¸å…¥æ‹¼éŸ³ (ä¸å«è²èª¿)</div>

    <div class="game-wrapper">
        <div class="clues-container">
            <div class="clue-section">
                <h3>â¡ æ©«å‘ (Across)</h3>
                <ul id="across-list"></ul>
            </div>
            <div class="clue-section">
                <h3>â¬‡ ç›´å‘ (Down)</h3>
                <ul id="down-list"></ul>
            </div>
        </div>

        <div id="crossword-board"></div>
    </div>

    <div class="controls">
        <button class="btn-check" onclick="checkAnswers()">æª¢æŸ¥ç­”æ¡ˆ</button>
        <button class="btn-reveal" onclick="revealAnswers()">é¡¯ç¤ºè§£ç­”</button>
        <button class="btn-retry" onclick="initGame()">é‡æ–°ç”Ÿæˆ</button>
    </div>

    <script src="words02.js"></script>

    <script>
        const BOARD_SIZE = 20; // æ‹¼éŸ³æ¯”è¼ƒé•·ï¼Œç¶²æ ¼åŠ å¤§åˆ° 20x20
        let grid = [];
        let activeWords = [];
        
        const boardEl = document.getElementById('crossword-board');
        const acrossListEl = document.getElementById('across-list');
        const downListEl = document.getElementById('down-list');

        if (typeof wordData === 'undefined') {
            alert("æ‰¾ä¸åˆ° words02.jsï¼Œè«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨ã€‚");
        }

        function initGame() {
            // æ¸…ç©ºèˆ‡é‡ç½®
            grid = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));
            activeWords = [];
            boardEl.innerHTML = '';
            acrossListEl.innerHTML = '';
            downListEl.innerHTML = '';

            // æª¢æŸ¥è³‡æ–™æ˜¯å¦æœ‰ pinyin æ¬„ä½
            const validData = wordData.filter(w => w.pinyin);
            if(validData.length === 0) {
                alert("è³‡æ–™éŒ¯èª¤ï¼šè«‹åœ¨ words02.js ä¸­ç‚ºæ¯å€‹å–®å­—åŠ å…¥ 'pinyin' æ¬„ä½ (ä¾‹å¦‚ pinyin: 'nihao')");
                return;
            }

            generateLayout(validData);
            drawBoard();
            renderClues();
        }

        function generateLayout(data) {
            // 1. æ¸…ç†è³‡æ–™ï¼šè½‰å¤§å¯«ï¼Œå»ç©ºæ ¼
            let words = data.map(item => ({
                ...item,
                cleanPinyin: item.pinyin.replace(/[^a-zA-Z]/g, '').toUpperCase(),
                isPlaced: false
            }));

            // 2. æ’åºï¼šé•·å­—å„ªå…ˆ
            words.sort((a, b) => b.cleanPinyin.length - a.cleanPinyin.length);

            // 3. æ”¾ç½®ç¬¬ä¸€å€‹å­—
            if (words.length > 0) {
                let first = words[0];
                let startRow = Math.floor(BOARD_SIZE / 2);
                let startCol = Math.floor((BOARD_SIZE - first.cleanPinyin.length) / 2);
                placeWord(first, startRow, startCol, 'across');
                first.isPlaced = true;
            }

            // 4. è²ªå©ªæ¼”ç®—æ³•æ”¾ç½®å…¶é¤˜å–®å­—
            for (let pass = 0; pass < 3; pass++) { // å¤šæƒå¹¾æ¬¡å¢åŠ æˆåŠŸç‡
                for (let i = 0; i < words.length; i++) {
                    let current = words[i];
                    if (current.isPlaced) continue;

                    let bestPos = findBestPosition(current.cleanPinyin);
                    if (bestPos) {
                        placeWord(current, bestPos.row, bestPos.col, bestPos.dir);
                        current.isPlaced = true;
                    }
                }
            }
        }

        function findBestPosition(text) {
            // éæ­·ç¶²æ ¼ä¸Šçš„æ¯å€‹æ ¼å­
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (grid[r][c]) {
                        // ç¶²æ ¼ä¸Šæœ‰å­—æ¯ï¼Œæª¢æŸ¥æ–°å–®å­—æ˜¯å¦æœ‰é€™å€‹å­—æ¯
                        let charOnGrid = grid[r][c].char;
                        
                        for (let i = 0; i < text.length; i++) {
                            if (text[i] === charOnGrid) {
                                // æ‰¾åˆ°å…±åŒå­—æ¯ï¼Œå˜—è©¦äº¤å‰æ”¾ç½®
                                // é€™è£¡çš„é‚è¼¯æ˜¯ï¼šå–®å­—é•·åº¦ text.lengthï¼Œäº¤å‰é»åœ¨å–®å­—çš„ç¬¬ i å€‹ä½ç½®
                                // æ‰€ä»¥èµ·å§‹ä½ç½®è¦æ¸›å» i
                                if (canPlace(text, r - i, c, 'down')) {
                                    return { row: r - i, col: c, dir: 'down' };
                                }
                                if (canPlace(text, r, c - i, 'across')) {
                                    return { row: r, col: c - i, dir: 'across' };
                                }
                            }
                        }
                    }
                }
            }
            return null;
        }

        function canPlace(text, row, col, dir) {
            if (row < 0 || col < 0) return false;
            
            // é‚Šç•Œæª¢æŸ¥
            if (dir === 'across') {
                if (col + text.length > BOARD_SIZE) return false;
                if (col > 0 && grid[row][col-1]) return false; // å·¦é‚Šä¸èƒ½æœ‰å­—
                if (col + text.length < BOARD_SIZE && grid[row][col+text.length]) return false; // å³é‚Šä¸èƒ½æœ‰å­—
            } else {
                if (row + text.length > BOARD_SIZE) return false;
                if (row > 0 && grid[row-1][col]) return false; // ä¸Šé¢ä¸èƒ½æœ‰å­—
                if (row + text.length < BOARD_SIZE && grid[row+text.length][col]) return false; // ä¸‹é¢ä¸èƒ½æœ‰å­—
            }

            for (let i = 0; i < text.length; i++) {
                let r = row + (dir === 'down' ? i : 0);
                let c = col + (dir === 'across' ? i : 0);

                if (grid[r][c]) {
                    // å¦‚æœæ ¼å­å·²æœ‰å­—ï¼Œå¿…é ˆå®Œå…¨ç›¸åŒ (äº¤å‰é»)
                    if (grid[r][c].char !== text[i]) return false;
                } else {
                    // å¦‚æœæ ¼å­æ˜¯ç©ºçš„ï¼Œæª¢æŸ¥"å…©å´"æ˜¯å¦æ·¨ç©º (é¿å…å¹³è¡Œç›¸é„°)
                    if (dir === 'across') {
                        if ((r > 0 && grid[r-1][c]) || (r < BOARD_SIZE-1 && grid[r+1][c])) return false;
                    } else {
                        if ((c > 0 && grid[r][c-1]) || (c < BOARD_SIZE-1 && grid[r][c+1])) return false;
                    }
                }
            }
            return true;
        }

        function placeWord(wordObj, row, col, dir) {
            activeWords.push({
                original: wordObj,
                row: row,
                col: col,
                dir: dir,
                number: 0
            });

            for (let i = 0; i < wordObj.cleanPinyin.length; i++) {
                let r = row + (dir === 'down' ? i : 0);
                let c = col + (dir === 'across' ? i : 0);
                grid[r][c] = { char: wordObj.cleanPinyin[i] };
            }
        }

        function drawBoard() {
            boardEl.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;

            // è¨ˆç®—é¡Œè™Ÿ
            activeWords.sort((a, b) => (a.row * BOARD_SIZE + a.col) - (b.row * BOARD_SIZE + b.col));
            let numberCounter = 1;
            let cellNumbers = {};

            activeWords.forEach(w => {
                let key = `${w.row},${w.col}`;
                if (!cellNumbers[key]) {
                    cellNumbers[key] = numberCounter++;
                }
                w.number = cellNumbers[key];
            });

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';

                    if (grid[r][c]) {
                        cell.classList.add('active');
                        
                        // é¡Œè™Ÿ
                        let key = `${r},${c}`;
                        if (cellNumbers[key]) {
                            let numSpan = document.createElement('span');
                            numSpan.className = 'cell-number';
                            numSpan.textContent = cellNumbers[key];
                            cell.appendChild(numSpan);
                        }

                        // è¼¸å…¥æ¡†
                        let input = document.createElement('input');
                        input.maxLength = 1;
                        input.dataset.answer = grid[r][c].char;
                        
                        // ç°¡å–®çš„è‡ªå‹•è·³ä¸‹æ ¼åŠŸèƒ½ (åƒ…æ©«å‘)
                        input.onkeyup = function(e) {
                            this.classList.remove('wrong', 'correct');
                            if(this.value.length === 1 && e.key.match(/[a-z]/i)) {
                                // å˜—è©¦æ‰¾ä¸‹ä¸€å€‹ input
                                // é€™è£¡åªæ˜¯ç°¡å–®å„ªåŒ–ï¼ŒçœŸæ­£çš„è·³æ ¼é‚è¼¯å¾ˆè¤‡é›œ
                            }
                        };

                        cell.appendChild(input);
                    }
                    boardEl.appendChild(cell);
                }
            }
        }

        function renderClues() {
            activeWords.forEach(w => {
                let li = document.createElement('li');
                // æç¤ºæ ¼å¼ï¼š 1. [æ¼¢å­—] English Meaning
                li.innerHTML = `<strong>${w.number}.</strong> <span class="hanzi-hint">${w.original.word}</span> ${w.original.meaning}`;
                
                if (w.dir === 'across') {
                    acrossListEl.appendChild(li);
                } else {
                    downListEl.appendChild(li);
                }
            });
        }

        function checkAnswers() {
            let inputs = document.querySelectorAll('.cell input');
            let correctCount = 0;

            inputs.forEach(input => {
                if (input.value.toUpperCase() === input.dataset.answer) {
                    input.classList.add('correct');
                    input.classList.remove('wrong');
                    correctCount++;
                } else if (input.value) {
                    input.classList.add('wrong');
                    input.classList.remove('correct');
                }
            });

            if (correctCount === inputs.length && inputs.length > 0) {
                setTimeout(() => alert("å¤ªæ£’äº†ï¼æ‹¼éŸ³å…¨å°ï¼ğŸ‰"), 100);
            }
        }

        function revealAnswers() {
            if(!confirm("ç¢ºå®šè¦å·çœ‹æ‰€æœ‰ç­”æ¡ˆå—ï¼Ÿ")) return;
            let inputs = document.querySelectorAll('.cell input');
            inputs.forEach(input => {
                input.value = input.dataset.answer;
                input.classList.add('correct');
            });
        }

        initGame();
    </script>
</body>
</html>